# Tutorial for OpenStack on Openshift; Deploying an overcloud in OCP with Openstack Director Operator (OSPdO)

> **WARNING**: The work exposed here is not supported in any way by Red Hat, this is the result of exploratory work. The information shared is solely for educational and informational purposes.


## TL:DL

- `provisioningNetwork` has to be set `Managaged`, so SNO cluster cannot be used. 
- `provisioningNetwork` has dedicate network for Baremetal node, this is seprate nework from OSP `controlplane`.  
- Dynamic provisioning is assumed. ODF is configured in this tutorial. Alternatively, [NFS](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/managing_file_systems/mounting-nfs-shares_managing-file-systems) also can be used. 


## Installing and preparing director Operator

1. Follow the offical step, make sure the cluster contains:

- A `baremetal` cluster operator
- OpenShift Virtualization Operator
- SR-IOV Operator 
- Kubernetes NMState Operator. Make sure to create an NMState instance.  
- A remote Git repository for OSPdO to store the generated configuration


## Installing director Operator
First step is to install OSPdO.

Follow [chapter 2.3](https://access.redhat.com/documentation/en-us/red_hat_openstack_platform/17.1/html-single/deploying_an_overcloud_in_a_red_hat_openshift_container_platform_cluster_with_director_operator/index#proc_installing-director-operator_installing-OSPdO) to obtain images and push it to your own registry. 

~~~shell
$ podman login registry.redhat.io
Username: {REGISTRY-SERVICE-ACCOUNT-USERNAME}
Password: {REGISTRY-SERVICE-ACCOUNT-PASSWORD}
Login Succeeded!

$ podman pull registry.redhat.io/rhosp-rhel8/osp-director-operator:1.3.0-9
~~~

Obtain the Operator Package Manager (opm) from [console.redhat.com](https://console.redhat.com/openshift/downloads.)

Then, use the `opm` tool to creat an index image:

~~~shell
BUNDLE_IMG="registry.redhat.io/rhosp-rhel9/osp-director-operator-bundle:1.3.1"
INDEX_IMG="quay.io/<account>/osp-director-operator-index:x.y.z-a"
opm index add --bundles ${BUNDLE_IMG} --tag ${INDEX_IMG} -u podman --pull-tool podman
~~~

Apply the following yaml to install OSPdO to the cluster.

~~~shell
$ oc apply -f 01-osp-director-operator.yaml

$ oc get operators
NAME                                                      AGE
osp-director-operator.openstack                           12d
~~~

## Creating a data volume for the base operating system
Follow chapter 2.4. you can use `02-uploadimg.sh` can be used. 
After sussful this step, `PVC` should be created.

![openstack-base-img pvc](./images/openstack-base-img.png)

## Authenticaion details for Git repo
OSPdO stores rendered Ansible playbooks which will be generated by `15-openstack-config-generator.yaml`. Update `03-git-secreat.sh` accodingly. 

~~~shell
$ ./03-git-secret.sh
~~~

## Setting root password for nodes
This step creates `Secret` that will be refered by `OpenStackControlPlane` and `OpenStackBareemtalSet` later. 

~~~shell
$ ./04-openstack-userpassword.yaml
~~~

## Setup Provisoning Server 
Before moving on creating OpenstackNetwork, setup provioning server for Baremetal node deployment. 
Metal3 will `introspection` to the compute node. 

### Setup Metal3

~~~shell
$ oc apply -f 05-metal3-provisioning.yaml 
provisioning.metal3.io/provisioning-configuration created

$ oc get pod -n openshift-machine-api
NAME                                                 READY   STATUS    RESTARTS   AGE
cluster-autoscaler-operator-779cfbf6bd-ccmvv         2/2     Running   0          44h
cluster-baremetal-operator-f7d7ccb77-dm7m2           2/2     Running   0          44h
control-plane-machine-set-operator-9b5d5f975-pcwlg   1/1     Running   0          44h
machine-api-controllers-c9969d888-rvkx9              7/7     Running   0          44h
machine-api-operator-574fb448fd-5mrqw                2/2     Running   0          44h
metal3-78674c457f-jk2xg                              6/6     Running   0          102s
metal3-baremetal-operator-65f9fdd6f4-7hwgl           1/1     Running   0          101s
metal3-image-customization-784c46f877-hzhr2          1/1     Running   0          99s
~~~
Wait until the metal3 container finds its ip address.

![metal3](images/metal3.png)
 
### Create a provisioning server
Before deploy `baremetal` Host, which will be our compute node, provisoning server needs to be up and waiting for PXE request on the provisioning network.

~~~shell
$ oc apply -f 06-openstack-provision.yaml 
openstackprovisionserver.osp-director.openstack.org/openstack-provision-server created

$ oc get openstackprovisionserver/openstack-provision-server -n openstack 
NAME                         STATUS        REASON
openstack-provision-server   Provisioned   OpenStackProvisionServer has been provisioned
~~~

### Add Baremetal Host into metal3 inventory
As chapter [2.2](https://access.redhat.com/documentation/en-us/red_hat_openstack_platform/17.1/html-single/deploying_an_overcloud_in_a_red_hat_openshift_container_platform_cluster_with_director_operator/index#con_baremetal-cluster-operators_installing-OSPdO) described, `metal3` manages baremeatl hosts. 
The following step will create a `baremetal` hosts and trigger metal3 inspection.

In this tutorial, Compute node is a VM and runnign `sushy` on the KVM. 

~~~shell
$ oc apply -f 07-bmh-compute.yaml 
secret/openstack-compute-bmc-secret created
baremetalhost.metal3.io/openstack-compute created
~~~
Make sure it is pxe booting from the provisioning network. 

![Alt text](images/bmh-pxe.png)

![Alt text](images/bmh-inspection.png)